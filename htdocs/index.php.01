<?php

include "../conf.php";
$t = $_SERVER['REQUEST_URI'];
$t = explode("/",$t);
$item = $t[1];
$item2 = $t[2];


switch($item)
{
    case "link":
	$browser = $_SERVER['HTTP_USER_AGENT'];
	$ip = $_SERVER['HTTP_X_FORWARDED_FOR'];
	
	unset($q);
	$q[hash] = $item2;
	$q_add = mas2sqlmas($q);
	$query = "SELECT * FROM link WHERE ".implode(" AND ",$q_add)."";
	//print $query."\n";
	$res = mysqli_query($con,$query);
	$kolvo = mysqli_num_rows($res);

	if($kolvo)
	{
	$row = mysqli_fetch_assoc($res);
	//print_r($row);
	if(!$row[browser])
	{
	    unset($q);
	    $q[browser] = $browser;
	    $q[ip] = $ip;
    	    $q_add = mas2sqlmas($q);
	    $query = "UPDATE link SET ".implode(",",$q_add)." WHERE id = '$row[id]'";
	    //print $query."\n";
	    $res = mysqli_query($con,$query);


	    print "Redirect after 2 sec";
	    print "<script>";
//	    print "";
	    print "localStorage.setItem('$key_name', '".$row[hash]."');";
	    print "setTimeout(reload,2000);";
	    print "function reload(){window.location.href = '/';}";
	    print "</script>";
	    die;
	}
	if($row[browser] && $row[browser] != $browser)
	{
	    $err = "Ссылка устарела.";
	    //die("err1");
	}

	if($row[browser] && $row[browser] == $browser)
	{
	    //die("err2");
	    header("Location: /");
	    die;
	}
	}
	else
	{
	    $err = "Ссылка не существует.";
	}

	if(!$err)
	$err = "Неведомая ошибка";

	if($err)
	{
	    $f = "index-err.html";
	    $a = file_get_contents($f);
	    $a = str_replace("<!--ERR_TEXT-->",$err,$a);
	    print $a;
	    //print $err;
	}
    
	die;
    break;
    default:
$f = "index.html";
$a = file_get_contents($f);

reset($mp3_mas);
$t = "";
$nn = 0;
$t = "<div class=\"titles-tab\">";
foreach($mp3_mas as $n=>$v)
{
    $nn++;
    $lock = "";
    if($v == "")$lock = "lock";
    $t .= "<a class=\"tab tab-$nn ".($nn==1?"active":"")." $lock\" href=\"#tab-#nn\"><span>$n</span></a>";
}
$t .= "</div>";

$a = str_replace("<div class=\"titles-tab\"></div>",$t,$a);
//$preg = "";
print $a;
//	    print "<script>";
//	    print "console.log(localStorage.getItem('$key_name'));";
//	    print "</script>";
//print_r($mp3_mas);
}
//phpinfo();die;


?>